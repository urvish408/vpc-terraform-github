name: Terraform CI with LocalStack

on:
  push:
    branches: [ "main" ]

env:
  AWS_ACCESS_KEY_ID: test
  AWS_SECRET_ACCESS_KEY: test
  AWS_DEFAULT_REGION: us-east-1

jobs:
  terraform-cicd:
    runs-on: ubuntu-latest

services:
  localstack:
    image: localstack/localstack-full:latest
    ports:
      - 4566:4566
    environment:
      - SERVICES=ec2,iam,s3,sts,cloudformation
      - DEBUG=1
      - DOCKER_HOST=unix:///var/run/docker.sock
    options: >-
      --memory=2g
      --health-cmd=awslocal ec2 describe-regions --endpoint-url=http://localhost:4566 || exit 1
      --health-interval=15s
      --health-timeout=10s
      --health-retries=60
      --health-start-period=60s

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        working-directory: ./terraform-vpc
        run: terraform init

      - name: Terraform Validate
        working-directory: ./terraform-vpc
        run: terraform validate

      - name: Terraform Plan
        working-directory: ./terraform-vpc
        run: terraform plan

      - name: Terraform Apply
        working-directory: ./terraform-vpc
        run: terraform apply -auto-approve
